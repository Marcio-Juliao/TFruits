<!DOCTYPE html>
<html lang="ptbr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TFruit</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="dashboard_dados.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">

</head>

<body onload="montarSelectDispositivo()">
    <!--Nav-->

    <div class="nav">
        <div class="nav_esquerda">
            <button class="sair"><a onclick="sair()">sair</a></button>
            <button class="dashboard">dashboard</button>
            <button class="cadastrar"><a href="dashboard_historico.html">hist√≥rico</a></button>
            <button class="cadastrar"><a href="dashboard_cadastrar.html">cadastrar</a></button>
            <button class="cadastrar"><a href="https://tfruitcontato.atlassian.net/servicedesk/customer/portal/2">suporte</a></button>
        </div>
        <div class="nav_direita">
            <div>
                <span id="b_usuario">usu√°rio</span><br>
                <span id="b_empresa">empresa</span>
            </div>
            <div class="img_nav">
                <img src="imagens/banana.png" alt="">
            </div>
        </div>
    </div>
    <!--informa√ß√µes-->
    <div class="infos">
        <div class="top">
            <div class="sensores">
                Dispositivos
                <select name="" id="sensor_select">
                    <option value="#" selected disabled>selecione o sensor</option>
                </select>
            </div>
            <div class="Temperatura">
                Temperatura
                nesse exato momento
                <div id="temperatura">
                    <div class="style_temp_alerta"></div>
                </div>
            </div>
            <div class="tempo">
                √∫ltima atualiza√ß√£o
                <div class="style_tempo">
                    06/05/2024 <br>
                    <time>12:00:00</time>
                </div>
            </div>
        </div>
        <button class="result" onclick="montarSelect(); geraResult();">mostrar resultados</button>
        <div id="alerta">
            <p></p>
        </div>
    </div>
    <!--informa√ß√µes especif√≠cas-->
    <div class="dispositivos" id="disp">
        Dispositivo
    </div>
    <div id="dados" class="dados">
        <div class="direita">
            <div class="elemento_1">
                <select name="" id="select_dia">
                    <option disabled selected>data</option>
                </select>
            </div>
            <div class="elemento_2">
                Temperatura M√©dia <br> Di√°ria
                <div id="temp">
                    <div class="result_alerta"></div>
                </div>
                <br><br>
                <button onclick="historicoDiario();contagemOcorrencia();" class="result">historico di√°rio</button>
            </div>
            <div class="elemento_3">
                <div class="perigo">üî¥ perigo</div>
                <div class="alerta">üü° alerta</div>
                <div class="ok">üü¢ est√° bem</div>
            </div>
        </div>
        <div id="esquerda" class="esquerda">
            <div class="gr√°fico_1">
                <h1>Gr√°fico - temperatura di√°ria</h1>
                <section style="width: 90%;">
                    <canvas id="myChart"></canvas>
                </section>
            </div>
            <div class="gr√°fico_2">
                <h1>Gr√°fico - contagem de ocorr√™ncia mensal</h1>
                <section style="width: 90%;">
                    <canvas id="myChart2"></canvas>
                </section>
            </div>
        </div>
    </div>

    <!--Footer-->
    <div class="footer">
        <img src="imagens/Logo_footer.png" alt="">
    </div>
</body>

</html>

<script>

    function geraResult() {
        result();
    }

    esquerda.style.display = "none";

    function sair() {
        sessionStorage.clear();
        window.location = "./index.html";
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    b_empresa.innerHTML = sessionStorage.NOME_EMPRESA;


    const showTimeNow = () => {
        //Selecinando a tag de destino
        const clockTag = document.querySelector('time');

        //Instanciando a classe Date
        let dateNow = new Date();
        //pegando os valores desejados
        let hh = dateNow.getHours();
        let mm = dateNow.getMinutes();
        let ss = dateNow.getSeconds();

        //validando a necessidade de adicionar zero na exibi√ß√£o
        hh = hh < 10 ? '0' + hh : hh;
        mm = mm < 10 ? '0' + mm : mm;
        ss = ss < 10 ? '0' + ss : ss;

        // atribuindo os valores e montando o formato da hora a ser exibido
        clockTag.innerText = hh + ':' + mm + ':' + ss;
    }
    //executando a funcao a cada 1 segundo
    showTimeNow()
    setInterval(showTimeNow, 1000);

    var globalDatasSelect = [];
    var globalDatasSelectDispositivo = [];


    function montarSelectDispositivo() {

        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/montarSelectDispositivo", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuarioVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    globalDatasSelectDispositivo = json;

                    for (var i = 0; i < (globalDatasSelectDispositivo.length); i++) {
                        var nomeAtual = globalDatasSelectDispositivo[i].nomeDispositivo;
                        var idAtual = globalDatasSelectDispositivo[i].idDispositivo;

                        sensor_select.innerHTML += `<option value="${idAtual}">${nomeAtual}</option>`

                    }

                });

            } else {

                console.log("Houve um erro ao tentar montar o select!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function montarSelect() {

        var idSensorVar = sensor_select.value;
        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/montarSelect", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuarioVar,
                idSensorServer: idSensorVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    globalDatasSelect = json;

                    for (var i = 0; i < (globalDatasSelect.length); i++) {
                        var dataAtual = globalDatasSelect[i].dataMedida;

                        select_dia.innerHTML += `<option value="${dataAtual}">${dataAtual}</option>`

                    }

                });

            } else {

                console.log("Houve um erro ao tentar montar o select!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    var dadosHistoricoDiario; // variavel global onde os dados obtidos ser√£o armazenados, montar o grafico com essa variavel
    function historicoDiario() { //precisa de um bot√£o embaixo do select da data tipo "exibir resultados", para que quando apertar, monte este grafico

        esquerda.style.display = "flex";

        var dataVar = select_dia.value;

        var [dia, mes, ano] = dataVar.split('/')

        var dataVar = `${ano}-${mes}-${dia}`;

        console.log(dataVar);

        fetch("/graficos/historicoDiario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                dataServer: dataVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    dadosHistoricoDiario = json;
                    ajustaFormatoDiario();
                    gerarGraficoDiario()

                });

            } else {

                console.log("Houve um erro ao tentar obter os dados do grafico de historico diario");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    // mesma coisa aqui
    var dadosContagemOcorrencia; // variavel global onde os dados obtidos ser√£o armazenados, montar o grafico com essa variavel
    function contagemOcorrencia() { //precisa de um bot√£o embaixo do select da data tipo "exibir resultados", para que quando apertar, monte este grafico

        var dataVar = select_dia.value;

        var [dia, mes, ano] = dataVar.split('/')

        var dataVar = `${ano}-${mes}-${dia}`;
        console.log(dataVar);

        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/contagemOcorrencia", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                dataServer: dataVar,
                idUsuarioServer: idUsuarioVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    dadosContagemOcorrencia = json;
                    GerarGraficoContagem()

                });

            } else {

                console.log("Houve um erro ao tentar obter os dados do grafico de historico diario");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function ajustaFormatoDiario() {

        dadosHistoricoDiario[0].hora = `${dadosHistoricoDiario[0].hora}:00`;
        console.log(`ajustado!: ${dadosHistoricoDiario[0].hora}`); 

    }

















    function result() {

        var id = sensor_select.value;

       setInterval( function () {

           fetch("/graficos/result", {
               method: "POST",
               headers: {
                   "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idServer: id
                })
            }).then(function (resposta) {
                
                if (resposta.ok) {
                    console.log(resposta);
                    
                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));

                        if (json[0].valor >= 12 && json[0].valor < 13) {
                            temperatura.innerHTML = `<div class="style_temp_ok">${json[0].valor}</div>`;
                        } else if (json[0].valor >= 10 && json[0].valor <= 14) {
                            temperatura.innerHTML = `<div class="style_temp_alerta">${json[0].valor}</div>`;
                        } else if (json[0].valor < 10 || json[0].valor > 14) {
                            temperatura.innerHTML = `<div class="style_temp_perigo">${json[0].valor}</div>`;
                            alerta.innerHTML=`<p>Caixa inst√°vel! A temeperatura chegou a ${json[0].valor}</p>`;
                        }
                        
                        
                        
                        
                    });
                    
                } else {
                    
                    console.log("Houve um erro ao tentar mostrar a temperatura");
                    
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
                
            }).catch(function (erro) {
                console.log(erro);
            })}
            
            ,5000)
        return false;
    }


    function gerarGraficoDiario() {

        var dadosGrafico = [];
        var horasGrafico = [];
        for (var i = 0; i < dadosHistoricoDiario.length; i++) {

            dadosGrafico.push(dadosHistoricoDiario[i].temperatura);
            horasGrafico.push(dadosHistoricoDiario[i].hora);

        }
    
        const data = {
            labels: horasGrafico,
            datasets: [{
                label: 'Temperatura',
                backgroundColor: '#F29F05',
                borderColor: '#F29F05',
                data: dadosGrafico
            }]
        };
    
        const config = {
            type: 'line',
            data: data,
            options: {
    
                scales: {
                    y: {
                        min: 0,
                        max: 30
                    }
                }
            }
        };
        const myChart = new Chart(document.getElementById('myChart'),
            config
        );



    }
    function GerarGraficoContagem() {

        var dadosGraficoOk = [];
        var dadosGraficoAlerta = [];
        var dia = []
        
        dadosGraficoOk.push(dadosContagemOcorrencia[0].OK)
        dadosGraficoAlerta.push(dadosContagemOcorrencia[0].ALERTA)
        dia.push(select_dia.value)
        
        
    
        const data2 = {
            labels: dia,
            datasets: [{
                label: 'Temperatura Ultrapassou',
                backgroundColor: '#A60303',
                borderColor: '#A60303',
                data: dadosGraficoAlerta
            }, {
                label: 'Temperatura Mantida',
                backgroundColor: '#558C03',
                borderColor: '#558C03',
                data: dadosGraficoOk
            }]
        };
    
        const config2 = {
            type: 'bar',
            data: data2,
            options: {
    
                scales: {
                    y: {
                        min: 0,
                        max: 30
                    }
                }
            }
        };
    
        const myChart2 = new Chart(document.getElementById('myChart2'),
            config2
        );
    }
</script>