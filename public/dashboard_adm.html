<!DOCTYPE html>
<html lang="ptbr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TFruit</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="dashboard_dados.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="../src/img/favicon.png" type="image/x-icon">

</head>

<body onload="montarSelectDispositivo()">
    <!--Nav-->

    <div class="nav">
        <div class="nav_esquerda">
            <button class="sair"><a onclick="sair()">sair</a></button>
            <button class="dashboard">dashboard</button>
            <button class="cadastrar"><a href="dashboard_historico.html">histÃ³rico</a></button>
            <button class="cadastrar"><a href="dashboard_cadastrar.html">cadastrar</a></button>
        </div>
        <div class="nav_direita">
            <div>
                <span id="b_usuario">usuÃ¡rio</span><br>
                <span id="b_empresa">empresa</span>
            </div>
            <div class="img_nav">
                <img src="imagens/banana.png" alt="">
            </div>
        </div>
    </div>
    <!--informaÃ§Ãµes-->
    <div class="infos">
        <div class="top">
            <div class="sensores">
                Dispositivos
                <select name="" id="sensor_select">
                    <option value="#" selected disabled>selecione o sensor</option>
                </select>
            </div>
            <div class="Temperatura">
                Temperatura
                nesse exato momento
                <div id="temperatura">
                    <div class="style_temp_alerta"></div>
                </div>
            </div>
            <div class="tempo">
                Ãºltima atualizaÃ§Ã£o
                <div class="style_tempo">
                    06/05/2024 <br>
                    <time>12:00:00</time>
                </div>
            </div>
        </div>
        <button class="result" onclick="montarSelect(); result();">mostrar resultados</button>
        <div id="alerta">
            <p></p>
        </div>
    </div>
    <!--informaÃ§Ãµes especifÃ­cas-->
    <div class="dispositivos" id="disp">
        Dispositivo
    </div>
    <div id="dados" class="dados">
        <div class="direita">
            <div class="elemento_1">
                <select name="" id="select_dia">
                    <option value="atual">atual</option>
                </select>
            </div>
            <div class="elemento_2">
                Temperatura MÃ©dia <br> DiÃ¡ria
                <div id="temp">
                    <div class="result_alerta"></div>
                </div>
                <br><br>
                <button onclick="historicoDiario()" class="result">historico diÃ¡rio</button>
            </div>
            <div class="elemento_3">
                <div class="perigo">ðŸ”´ perigo</div>
                <div class="alerta">ðŸŸ¡ alerta</div>
                <div class="ok">ðŸŸ¢ estÃ¡ bem</div>
            </div>
        </div>
        <div id="esquerda" class="esquerda">
            <div class="grÃ¡fico_1">
                <h1>GrÃ¡fico - temperatura diÃ¡ria</h1>
                <section style="width: 90%;">
                    <canvas id="myChart"></canvas>
                </section>
            </div>
            <div class="grÃ¡fico_2">
                <h1>GrÃ¡fico - contagem de ocorrÃªncia mensal</h1>
                <section style="width: 90%;">
                    <canvas id="myChart2"></canvas>
                </section>
            </div>
        </div>
    </div>

    <!--Footer-->
    <div class="footer">
        <img src="imagens/Logo_footer.png" alt="">
    </div>
</body>

</html>

<script>

    esquerda.style.display = "none";

    function sair() {
        sessionStorage.clear();
        window.location = "./index.html";
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    b_empresa.innerHTML = sessionStorage.NOME_EMPRESA;


    const showTimeNow = () => {
        //Selecinando a tag de destino
        const clockTag = document.querySelector('time');

        //Instanciando a classe Date
        let dateNow = new Date();
        //pegando os valores desejados
        let hh = dateNow.getHours();
        let mm = dateNow.getMinutes();
        let ss = dateNow.getSeconds();

        //validando a necessidade de adicionar zero na exibiÃ§Ã£o
        hh = hh < 10 ? '0' + hh : hh;
        mm = mm < 10 ? '0' + mm : mm;
        ss = ss < 10 ? '0' + ss : ss;

        // atribuindo os valores e montando o formato da hora a ser exibido
        clockTag.innerText = hh + ':' + mm + ':' + ss;
    }
    //executando a funcao a cada 1 segundo
    showTimeNow()
    setInterval(showTimeNow, 1000);

    var globalDatasSelect = [];
    var globalDatasSelectDispositivo = [];


    function montarSelectDispositivo() {

        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/montarSelectDispositivo", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuarioVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    globalDatasSelectDispositivo = json;

                    for (var i = 0; i < (globalDatasSelectDispositivo.length); i++) {
                        var nomeAtual = globalDatasSelectDispositivo[i].nomeDispositivo;
                        var idAtual = globalDatasSelectDispositivo[i].idDispositivo;

                        sensor_select.innerHTML += `<option value="${idAtual}">${nomeAtual}</option>`

                    }

                });

            } else {

                console.log("Houve um erro ao tentar montar o select!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function montarSelect() {

        var idSensorVar = sensor_select.value;
        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/montarSelect", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuarioVar,
                idSensorServer: idSensorVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    globalDatasSelect = json;

                    for (var i = 0; i < (globalDatasSelect.length); i++) {
                        var dataAtual = globalDatasSelect[i].dataMedida;

                        select_dia.innerHTML += `<option value="${dataAtual}">${dataAtual}</option>`

                    }

                });

            } else {

                console.log("Houve um erro ao tentar montar o select!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    var dadosHistoricoDiario; // variavel global onde os dados obtidos serÃ£o armazenados, montar o grafico com essa variavel
    function historicoDiario() { //precisa de um botÃ£o embaixo do select da data tipo "exibir resultados", para que quando apertar, monte este grafico

        esquerda.style.display = "flex";

        var dataVar = select_dia.value;

        var [dia, mes, ano] = dataVar.split('/')

        var dataVar = `${ano}-${mes}-${dia}`;

        console.log(dataVar);

        fetch("/graficos/historicoDiario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                dataServer: dataVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    dadosHistoricoDiario = json;
                    ajustaFormatoDiario();

                });

            } else {

                console.log("Houve um erro ao tentar obter os dados do grafico de historico diario");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    // mesma coisa aqui
    var dadosContagemOcorrencia; // variavel global onde os dados obtidos serÃ£o armazenados, montar o grafico com essa variavel
    function contagemOcorrencia() { //precisa de um botÃ£o embaixo do select da data tipo "exibir resultados", para que quando apertar, monte este grafico

        var dataVar = select_dia.value;

        var [dia, mes, ano] = dataVar.split('/')

        var dataVar = `${ano}-${mes}-${dia}`;
        console.log(dataVar);

        var idUsuarioVar = sessionStorage.ID_USUARIO;

        fetch("/graficos/contagemOcorrencia", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                dataServer: dataVar,
                idUsuarioServer: idUsuarioVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    dadosContagemOcorrencia = json;

                });

            } else {

                console.log("Houve um erro ao tentar obter os dados do grafico de historico diario");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function ajustaFormatoDiario() {

        dadosHistoricoDiario[0].hora = `${dadosHistoricoDiario[0].hora}:00`;
        console.log(`ajustado!: ${dadosHistoricoDiario[0].hora}`); 

    }

















    function result() {

        var sensor = sensor_select.value

        disp.innerHTML = ` Dispositivo ${sensor} `

        if (sensor == 1 || sensor == 2 || sensor == 4 || sensor == 5 || sensor == 8 || sensor == 9) {
            temperatura.innerHTML = '<div class="style_temp_perigo">20Â°</div>'
            temp.innerHTML = `<div class="result_perigo">${(17 + 20) / 2}</div>`

        }
        else if (sensor == "#") {
            temperatura.innerHTML = ""
            temp.innerHTML = ""
        }
        else if (sensor == "all") {
            temperatura.innerHTML = `<div class="style_temp_alerta">mÃ©dia de : ${(12 + 17) / 2}</div> `
            temp.innerHTML = `<div class="result_alerta">${(12 + 17) / 2}</div>`
        }
        else {
            temperatura.innerHTML = '<div class="style_temp_ok">12Â°</div>'
            temp.innerHTML = `<div class="result_ok">${(12 + 12) / 2}</div>`
        }

        setTimeout(() => {
            alerta.innerHTML = `<p> ðŸ”´ Caixa ${sensor} - estÃ¡ em perigo! EstÃ¡ com 20Âº!</p>`
        }, 1000);

    }

    const labels = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00'];

    const data = {
        labels: labels,
        datasets: [{
            label: 'Temperatura',
            backgroundColor: '#F29F05',
            borderColor: '#F29F05',
            data: [16, 17, 17, 16, 16, 17]
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {

            scales: {
                y: {
                    min: 0,
                    max: 30
                }
            }
        }
    };
    const myChart = new Chart(document.getElementById('myChart'),
        config
    );
    const labels2 = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho'];

    const data2 = {
        labels: labels2,
        datasets: [{
            label: 'Temperatura Ultrapassou',
            backgroundColor: '#A60303',
            borderColor: '#A60303',
            data: [10, 5, 6, 5, 1, 0]
        }, {
            label: 'Temperatura Mantida',
            backgroundColor: '#558C03',
            borderColor: '#558C03',
            data: [20, 25, 24, 25, 29, 30]
        }]
    };

    const config2 = {
        type: 'bar',
        data: data2,
        options: {

            scales: {
                y: {
                    min: 0,
                    max: 30
                }
            }
        }
    };

    const myChart2 = new Chart(document.getElementById('myChart2'),
        config2
    );
</script>